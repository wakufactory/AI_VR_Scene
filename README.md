# AI VR Scene Maker マニュアル
 
## 1. 概要

このツールは、Node.js ベースのサーバと HTML/JavaScript を用いたクライアントで構成され、ChatGPT API を利用してチャット応答と WebXR コンテンツを生成する AI エージェントです。  
- **チャット履歴管理**: 各プロジェクトごとにチャット履歴はサーバ側の `log` フォルダ内に `プロジェクト名.json` として保存されます。  
- **システムプロンプト管理**:  
	- 固定システムプロンプトはサーバ側で `log/fixedSystemPrompt.txt` に保存され、手動で更新します。  
	- ユーザシステムプロンプトは、クライアントから送信された内容が `log/userSystemPrompt.txt` に保存され、全プロジェクト共通で管理されます。  
	- サーバ側では、これら２つのプロンプトを結合して、ChatGPT API へ送信するシステムメッセージとして利用します。  
- **HTML コンテンツ生成**:  
	ChatGPT API の応答に含まれる HTML 部分があれば、`public` フォルダ内に `プロジェクト名.html` として保存され、クライアントの右側パネルのプレビューに表示されます。  
- **クライアント側の動作**:  
	- &#34;プロジェクト設定&#34; ボタンを押すと、現在のプロジェクト名に応じたチャット履歴とユーザシステムプロンプトがサーバから読み込まれ、画面が更新されます。  
	- メッセージ送信後、サーバからの返信が返ってきた後に入力欄がクリアされます。  
- **HTTPS 接続**:  
	サーバは自己署名証明書（`key.pem` と `cert.pem`）を利用して HTTPS 経由で動作します。  

## 2. 必要な環境

- **Node.js**：最新版を推奨  
- **npm**：依存モジュール管理  
- **OpenSSL**：自己署名証明書の生成に利用  
- **ブラウザ**：HTTPS に対応（自己署名証明書の場合、警告が表示されます）
- **API Key**: OpenAIのAPI Keyを取得してください

## 3. ディレクトリ構造例
 
```
/your-project-directory
├── server.js                 // サーバサイドのメインコード（HTTPS 対応）
├── package.json              // npm の依存関係ファイル
├── .env                      // API キーなどの環境変数を設定するファイル
├── key.pem                   // 自己署名証明書の秘密鍵
├── cert.pem                  // 自己署名証明書
├── log                       // チャット履歴やシステムプロンプト保存用フォルダ
│   ├── fixedSystemPrompt.txt // 固定システムプロンプト（手動更新）
│   ├── userSystemPrompt.txt  // ユーザシステムプロンプト
│   └── [プロジェクト名].json // 各プロジェクトごとのチャット履歴
└── public
		├── index.html            // クライアント側のHTMLファイル
		└── [プロジェクト名].html // 生成された HTML プレビュー用ファイル
```

## 4. 設定方法

### 4.1. 環境変数の設定 (.env)

プロジェクトルートに `.env` ファイルを作成し、以下の内容を記述します。

```env
OPENAI_API_KEY=sk-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
PORT=3000
```

- `OPENAI_API_KEY` は発行された実際の API キーに置き換えてください。

### 4.2. 自己署名証明書の作成

ローカル環境で HTTPS 接続を有効にするため、以下のコマンドで自己署名証明書を生成します。

```bash
openssl req -nodes -new -x509 -keyout key.pem -out cert.pem -days 365
```

- 生成された `key.pem` と `cert.pem` をプロジェクトルートに配置してください。

### 4.3. システムプロンプトファイルの準備

- **固定システムプロンプト**:  
	手動で `log/fixedSystemPrompt.txt` を作成し、必要な固定メッセージ（例：仕様や注意事項）を記述します。

- **ユーザシステムプロンプト**:  
	このファイル（`log/userSystemPrompt.txt`）は、クライアントから送信された内容で自動更新されます。

## 5. サーバの起動方法

1. **npm モジュールのインストール**  
	 プロジェクトディレクトリで以下のコマンドを実行してください。

	 ```bash
	 npm install
	 ```

2. **サーバの起動**  
	 HTTPS 接続対応のサーバは以下のコマンドで起動します。

	 ```bash
	 node server.js
	 ```

	 - サーバは `.env` に指定されたポート（例：3000）で HTTPS 経由で稼働します。  
	 - ブラウザでアクセスする際、自己署名証明書の場合はセキュリティ警告が表示されますので、適切に許可してください。

## 6. クライアントの使い方

クライアントは `public/index.html` をブラウザで開いて利用します。画面は左右に分割され、左側にチャットインターフェース、右側に HTML プレビューが表示されます。

### 6.1. 左側パネル（チャットインターフェース）

- **プロジェクト名設定**:  
	プロジェクト名入力欄に任意のプロジェクト名を入力し、&#34;プロジェクト設定&#34; ボタンを押すと、サーバからそのプロジェクトに対応するチャット履歴とユーザシステムプロンプトが読み込まれ、HTML プレビューも更新されます。

- **履歴クリア**:  
	&#34;履歴クリア&#34; ボタンを押すと、サーバ側の該当プロジェクトのチャット履歴ファイル（`log/[プロジェクト名].json`）が削除され、画面上も空になります。

- **システムプロンプト（ユーザ入力）**:  
	ユーザは追加の仕様や注意事項を入力します。  
	この内容はサーバ側の `log/userSystemPrompt.txt` に保存され、全プロジェクト共通で使用されます。  
	固定システムプロンプトは、クライアント側には表示されず、手動で更新される `log/fixedSystemPrompt.txt` から読み込まれます。

- **チャットメッセージ送信**:  
	&#34;メッセージ&#34; 欄にチャット内容を入力し、&#34;送信&#34; ボタンを押すと、サーバへリクエストが送信されます。  
	サーバからの返信が返ってきた後に、入力欄がクリアされます。

- **プログレスインジケーター**:  
	サーバからの応答を待っている間、点滅する &#34;考え中&#34; の表示が出ます。

### 6.2. 右側パネル（HTML プレビュー）

- サーバ側で生成された HTML コンテンツは、`public/[プロジェクト名].html` として保存され、右側の iframe 内に表示されます。  
- プロジェクト設定時やチャット送信後に、最新状態が反映されます。

## 7. 動作の流れ

1. **初期表示**:  
	 ブラウザで `public/index.html` を開くと、ページタイトルは &#34;AI VR Scene Maker&#34; となり、左側パネルにはプロジェクト名、ユーザシステムプロンプト、メッセージ入力欄、チャット履歴が表示され、右側にはHTML プレビューが表示されます。

2. **プロジェクト設定**:  
	 プロジェクト名を入力し、&#34;プロジェクト設定&#34; ボタンをクリックすると、サーバからそのプロジェクトのチャット履歴とユーザシステムプロンプトが読み込まれ、HTML プレビューも更新されます。

3. **チャット送信**:  
	 ユーザがメッセージを入力し、&#34;送信&#34; ボタンをクリックすると、サーバへ POST リクエストが送信されます。  
	 サーバ側では、ユーザシステムプロンプトが更新され、固定システムプロンプトと結合されたシステムメッセージがチャット履歴の先頭に追加されます。  
	 ChatGPT API からの応答により、アシスタントの返信がチャット履歴に追加され、必要に応じて HTML コンテンツが `public/[プロジェクト名].html` に保存されます。  
	 クライアントはサーバから最新のチャット履歴を取得し、表示するとともに、サーバからの返信後にメッセージ入力欄がクリアされます。

4. **履歴の削除**:  
	 &#34;履歴クリア&#34; ボタンを押すと、該当プロジェクトのチャット履歴ファイル（`log/[プロジェクト名].json`）が削除され、画面上も空になります。

## 8. 注意事項

- **固定システムプロンプトの管理**:  
	固定システムプロンプトはクライアント側からは操作せず、`log/fixedSystemPrompt.txt` を手動で更新してください。

- **HTTPS の利用**:  
	サーバは自己署名証明書を利用して HTTPS 経由で動作します。開発・テスト環境向けですので、本番環境では正式な証明書をご利用ください。

- **データ管理**:  
	チャット履歴およびユーザシステムプロンプトはサーバ側のファイル（`log` フォルダ内）で管理されます。プロジェクト名に応じたファイルが作成されるため、プロジェクト設定で正しいプロジェクト名を使用してください。
