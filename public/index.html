<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>AI VR Scene Maker</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      overflow: hidden;
      font-family: sans-serif;
      background-color: #222;
      color: #fff;
    }
    #container {
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    header {
      flex: 0 0 60px;
      background-color: #333;
      padding: 10px;
      box-sizing: border-box;
    }
    header h1 {
      margin: 0;
      font-size: 1.5em;
    }
    #mainContent {
      flex: 1;
      display: flex;
      overflow: hidden;
    }
    #leftPanel, #rightPanel {
      padding: 10px;
      box-sizing: border-box;
      overflow: auto;
      background-color: #222;
    }
    #leftPanel {
      flex: 1;
      max-width: 50%;
    }
    #rightPanel {
      flex: 1;
      max-width: 50%;
      border-left: 1px solid #444;
    }
    #chatHistory {
      border: 1px solid #444;
      padding: 10px;
      margin-top: 10px;
      height: 400px;
      overflow-y: auto;
      background-color: #333;
    }
    #htmlDisplay {
      width: 100%;
      height: 100%;
      border: 1px solid #444;
      background-color: #111;
    }
    #progressIndicator {
      display: none;
      font-weight: bold;
      color: #fff;
      margin-top: 10px;
      animation: blink 1s linear infinite;
    }
    @keyframes blink {
      0% { opacity: 1; }
      50% { opacity: 0; }
      100% { opacity: 1; }
    }
    input, textarea, button {
      background-color: #333;
      border: 1px solid #444;
      color: #fff;
    }
    input::placeholder, textarea::placeholder {
      color: #aaa;
    }
    button {
      cursor: pointer;
    }
    span.user {
      color:#f88;
    }
    span.user:before {
      content:'üë§' ;
    }
    span.assistant:before {
      content:'ü§ñ' ;
    }
    a { color:#88f;}
  </style>
</head>
<body>
  <div id="container">
    <header>
      <h1>AI VR Scene Maker</h1>
      <a href="list.html" target="_blank">generated list</a>
    </header>
    <div id="mainContent">
      <div id="leftPanel">
        <div>
          <label for="projectName">„Éó„É≠„Ç∏„Çß„ÇØ„ÉàÂêçÔºö</label>
          <input type="text" id="projectName" placeholder="„Éó„É≠„Ç∏„Çß„ÇØ„ÉàÂêç„ÇíÂÖ•Âäõ" value="project">
          <button id="setProject">„Éó„É≠„Ç∏„Çß„ÇØ„ÉàË®≠ÂÆö</button>
          <button id="clearHistory">Â±•Ê≠¥„ÇØ„É™„Ç¢</button>
        </div>
        <div style="margin-top:10px;">
          <label for="systemPrompt">„Ç∑„Çπ„ÉÜ„É†„Éó„É≠„É≥„Éó„ÉàÔºà„É¶„Éº„Ç∂ÂÖ•ÂäõÔºâÔºö</label><br>
          <textarea id="systemPrompt" rows="4" cols="50" placeholder="ËøΩÂä†„ÅÆ‰ªïÊßò„ÇíÂÖ•Âäõ"></textarea>
        </div>
        <div style="margin-top:10px;">
          <label for="chatInput">„É°„ÉÉ„Çª„Éº„Ç∏Ôºö</label><br>
          <textarea id="chatInput" placeholder="„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂÖ•Âäõ" rows="3" cols="50"></textarea><br>
          <button id="sendChat">ÈÄÅ‰ø°</button>
        </div>
        <div id="progressIndicator">ËÄÉ„Åà‰∏≠</div>
        <div id="chatHistory"></div>
      </div>
      <div id="rightPanel">
        <iframe id="htmlDisplay" src=""></iframe>
      </div>
    </div>
  </div>
  
  <script>
    // „É¶„Éº„Ç∂„Ç∑„Çπ„ÉÜ„É†„Éó„É≠„É≥„Éó„Éà„ÅØÂÖ®„Éó„É≠„Ç∏„Çß„ÇØ„ÉàÂÖ±ÈÄö„ÅÆ„ÇÇ„ÅÆ„Å®„Åó„Å¶„Çµ„Éº„Éê„Å´‰øùÂ≠ò„Åï„Çå„Çã
    const SYSTEM_PROMPT_KEY = 'systemPrompt_common';

    // „Éó„É≠„Ç∏„Çß„ÇØ„ÉàÂêçÂèñÂæóÔºàÁ©∫„Å™„Çâ "project"Ôºâ
    function getProjectName() {
      const name = document.getElementById('projectName').value.trim();
      return name ? name : "project";
    }

    // „Éö„Éº„Ç∏Ë™≠„ÅøËæº„ÅøÊôÇ„ÄÅ„É≠„Éº„Ç´„É´„Çπ„Éà„É¨„Éº„Ç∏„Å´‰øùÂ≠ò„Åï„Çå„Åü„Éó„É≠„Ç∏„Çß„ÇØ„ÉàÂêç„ÇíÂèçÊò†
    const savedProjectName = localStorage.getItem('currentProjectName');
    if (savedProjectName) {
      document.getElementById('projectName').value = savedProjectName;
    }

    // „É¶„Éº„Ç∂„Ç∑„Çπ„ÉÜ„É†„Éó„É≠„É≥„Éó„Éà„ÅÆË™≠„ÅøËæº„ÅøÔºà„Çµ„Éº„Éê„Åã„ÇâÂèñÂæóÔºâ
    async function loadUserSystemPrompt() {
      try {
        const response = await fetch('/systemPrompt/user');
        if (response.ok) {
          const data = await response.json();
          document.getElementById('systemPrompt').value = data.userSystemPrompt || "";
        }
      } catch (e) {
        console.error("Error loading user system prompt:", e);
      }
    }

    // „Çµ„Éº„Éê„Åã„Çâ„ÉÅ„É£„ÉÉ„ÉàÂ±•Ê≠¥„ÇíÂèñÂæó„Åó„Å¶Ë°®Á§∫„Åô„Çã
    async function loadChatHistory() {
      const projectName = getProjectName();
      try {
        const response = await fetch(`/chatHistory?projectName=${encodeURIComponent(projectName)}`);
        if (response.ok) {
          const history = await response.json();
          updateChatHistoryDisplay(history);
        } else {
          updateChatHistoryDisplay([]);
        }
      } catch (e) {
        console.error("Error loading chat history:", e);
        updateChatHistoryDisplay([]);
      }
    }

    // „ÉÅ„É£„ÉÉ„ÉàÂ±•Ê≠¥Ë°®Á§∫Êõ¥Êñ∞„Å®Ëá™Âãï„Çπ„ÇØ„É≠„Éº„É´
    function updateChatHistoryDisplay(history) {
      const chatDiv = document.getElementById('chatHistory');
      chatDiv.innerHTML = '';
      history.forEach(msg => {
        const p = document.createElement('p');
        p.innerHTML = `<span class=${msg.role}>${msg.role}: ${msg.content.replaceAll('<','&lt;')}</span>`;
        chatDiv.appendChild(p);
      });
      chatDiv.scrollTop = chatDiv.scrollHeight;
    }

      // iframe Êõ¥Êñ∞ÔºöÁîüÊàêHTML„ÅØ /gen/ „ÅÆ„Éë„Çπ„ÅßÂèÇÁÖß„Åô„Çã
      function updateIframe() {
        const projectName = getProjectName();
        document.getElementById('htmlDisplay').src = `/gen/${projectName}.html?t=${new Date().getTime()}`;
      }


    // „Éó„É≠„Ç∏„Çß„ÇØ„ÉàË®≠ÂÆö„Éú„Çø„É≥ÔºöÊäº„Åï„Çå„Åü„Å®„Åç„Å´„ÄÅ„Çµ„Éº„Éê„Åã„ÇâÂ±•Ê≠¥„Å®„É¶„Éº„Ç∂„Ç∑„Çπ„ÉÜ„É†„Éó„É≠„É≥„Éó„Éà„ÇíË™≠„ÅøËæº„Åø„ÄÅ„Éó„É≠„Ç∏„Çß„ÇØ„ÉàÂêç„Çí‰øùÂ≠ò„Åô„Çã
    document.getElementById('setProject').addEventListener('click', async () => {
      const projectName = getProjectName();
      localStorage.setItem('currentProjectName', projectName);
      await loadUserSystemPrompt();
      await loadChatHistory();
      updateIframe();
    });

    // „Éö„Éº„Ç∏Ë™≠„ÅøËæº„ÅøÊôÇ„Å´„Éó„É≠„Ç∏„Çß„ÇØ„Éà„Åî„Å®„ÅÆÂ±•Ê≠¥„Å®„É¶„Éº„Ç∂„Ç∑„Çπ„ÉÜ„É†„Éó„É≠„É≥„Éó„Éà„ÇíË™≠„ÅøËæº„ÇÄ
    window.addEventListener('load', async () => {
      await loadUserSystemPrompt();
      await loadChatHistory();
      updateIframe();
    });

    // „ÉÅ„É£„ÉÉ„ÉàÈÄÅ‰ø°Âá¶ÁêÜÔºö„Çµ„Éº„Éê„Åã„Çâ„ÅÆËøî‰ø°Âæå„Å´„É°„ÉÉ„Çª„Éº„Ç∏ÂÖ•ÂäõÊ¨Ñ„Çí„ÇØ„É™„Ç¢„Åô„Çã
    document.getElementById('sendChat').addEventListener('click', async () => {
      const projectName = getProjectName();
      const userSystemPrompt = document.getElementById('systemPrompt').value;
      const payload = {
        userSystemPrompt: userSystemPrompt,
        userMessage: document.getElementById('chatInput').value,
        projectName: projectName
      };
      document.getElementById('progressIndicator').style.display = 'block';
      try {
        const response = await fetch('/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        await response.json();
        await loadChatHistory();
        updateIframe();
        // „Çµ„Éº„Éê„Åã„Çâ„ÅÆËøî‰ø°Âæå„Å´„É°„ÉÉ„Çª„Éº„Ç∏ÂÖ•ÂäõÊ¨Ñ„Çí„ÇØ„É™„Ç¢„Åô„Çã
        document.getElementById('chatInput').value = "";
      } catch (error) {
        console.error('Error sending chat:', error);
      } finally {
        document.getElementById('progressIndicator').style.display = 'none';
      }
    });

    // Â±•Ê≠¥„ÇØ„É™„Ç¢„Éú„Çø„É≥Ôºö„Çµ„Éº„Éê‰∏ä„ÅÆ„ÉÅ„É£„ÉÉ„ÉàÂ±•Ê≠¥„ÇíÂâäÈô§„Åô„Çã
    document.getElementById('clearHistory').addEventListener('click', async () => {
      const projectName = getProjectName();
      try {
        const response = await fetch(`/chatHistory?projectName=${encodeURIComponent(projectName)}`, { method: 'DELETE' });
        if (response.ok) {
          updateChatHistoryDisplay([]);
        }
      } catch (e) {
        console.error("Error clearing chat history:", e);
      }
    });
  </script>
</body>
</html>
