<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>AI VR Scene Maker</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      overflow: hidden;
      font-family: sans-serif;
      background-color: #222;
      color: #fff;
    }
    #container {
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    header {
      flex: 0 0 60px;
      background-color: #333;
      padding: 10px;
      box-sizing: border-box;
    }
    header h1 {
      margin: 0;
      font-size: 1.5em;
    }
    #mainContent {
      flex: 1;
      display: flex;
      overflow: hidden;
    }
    #leftPanel, #rightPanel {
      padding: 10px;
      box-sizing: border-box;
      overflow: auto;
      background-color: #222;
    }
    #leftPanel {
      flex: 1;
      max-width: 50%;
    }
    #rightPanel {
      flex: 1;
      max-width: 50%;
      border-left: 1px solid #444;
    }
    #chatHistory {
      border: 1px solid #444;
      padding: 10px;
      margin-top: 10px;
      height: 400px;
      overflow-y: auto;
      background-color: #333;
    }
    #htmlDisplay {
      width: 100%;
      height: 100%;
      border: 1px solid #444;
      background-color: #111;
    }
    #progressIndicator {
      display: none;
      font-weight: bold;
      color: #fff;
      margin-top: 10px;
      animation: blink 1s linear infinite;
    }
    @keyframes blink {
      0% { opacity: 1; }
      50% { opacity: 0; }
      100% { opacity: 1; }
    }
    input, textarea, button {
      background-color: #333;
      border: 1px solid #444;
      color: #fff;
    }
    input::placeholder, textarea::placeholder {
      color: #aaa;
    }
    button {
      cursor: pointer;
    }
    span.user {
      color:#f88;
    }
    span.user:before {
      content:'ğŸ‘¤' ;
    }
    span.assistant:before {
      content:'ğŸ¤–' ;
    }
    a { color:#88f;}
  </style>
</head>
<body>
  <div id="container">
    <header>
      <h1>AI VR Scene Maker</h1>
      <a href="list.html" target="_blank">generated list</a>
    </header>
    <div id="mainContent">
      <div id="leftPanel">
        <div>
          <label for="projectName">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåï¼š</label>
          <input type="text" id="projectName" placeholder="ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåã‚’å…¥åŠ›" value="project">
          <button id="setProject">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¨­å®š</button>
          <button id="clearHistory">å±¥æ­´ã‚¯ãƒªã‚¢</button>
        </div>
        <div style="margin-top:10px;">
          <label for="systemPrompt">ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼ˆãƒ¦ãƒ¼ã‚¶å…¥åŠ›ï¼‰ï¼š</label><br>
          <textarea id="systemPrompt" rows="4" cols="50" placeholder="è¿½åŠ ã®ä»•æ§˜ã‚’å…¥åŠ›"></textarea>
        </div>
        <div style="margin-top:10px;">
          <label for="chatInput">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼š</label><br>
          <textarea id="chatInput" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›" rows="3" cols="50"></textarea><br>
          <button id="sendChat">é€ä¿¡</button>
        </div>
        <div id="progressIndicator">è€ƒãˆä¸­</div>
        <div id="chatHistory"></div>
      </div>
      <div id="rightPanel">
        <iframe id="htmlDisplay" src=""></iframe>
      </div>
    </div>
  </div>
  
  <script>
    // ãƒ¦ãƒ¼ã‚¶ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã¯å…¨ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå…±é€šã®ã‚‚ã®ã¨ã—ã¦ã‚µãƒ¼ãƒã«ä¿å­˜ã•ã‚Œã‚‹
    const SYSTEM_PROMPT_KEY = 'systemPrompt_common';

    // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåå–å¾—ï¼ˆç©ºãªã‚‰ "project"ï¼‰
    function getProjectName() {
      const name = document.getElementById('projectName').value.trim();
      return name ? name : "project";
    }

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã€ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜ã•ã‚ŒãŸãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåã‚’åæ˜ 
    const savedProjectName = localStorage.getItem('currentProjectName');
    if (savedProjectName) {
      document.getElementById('projectName').value = savedProjectName;
    }

    // ãƒ¦ãƒ¼ã‚¶ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®èª­ã¿è¾¼ã¿ï¼ˆã‚µãƒ¼ãƒã‹ã‚‰å–å¾—ï¼‰
    async function loadUserSystemPrompt() {
      try {
        const response = await fetch('/systemPrompt/user');
        if (response.ok) {
          const data = await response.json();
          document.getElementById('systemPrompt').value = data.userSystemPrompt || "";
        }
      } catch (e) {
        console.error("Error loading user system prompt:", e);
      }
    }

    // ã‚µãƒ¼ãƒã‹ã‚‰ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‚’å–å¾—ã—ã¦è¡¨ç¤ºã™ã‚‹
    async function loadChatHistory() {
      const projectName = getProjectName();
      try {
        const response = await fetch(`/chatHistory?projectName=${encodeURIComponent(projectName)}`);
        if (response.ok) {
          const history = await response.json();
          updateChatHistoryDisplay(history);
        } else {
          updateChatHistoryDisplay([]);
        }
      } catch (e) {
        console.error("Error loading chat history:", e);
        updateChatHistoryDisplay([]);
      }
    }

    // ãƒãƒ£ãƒƒãƒˆå±¥æ­´è¡¨ç¤ºæ›´æ–°ã¨è‡ªå‹•ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
    function updateChatHistoryDisplay(history) {
      const chatDiv = document.getElementById('chatHistory');
      chatDiv.innerHTML = '';
      history.forEach(msg => {
        const p = document.createElement('p');
        p.innerHTML = `<span class=${msg.role}>${msg.role}: ${msg.content.replaceAll('<','&lt;')}</span>`;
        chatDiv.appendChild(p);
      });
      chatDiv.scrollTop = chatDiv.scrollHeight;
    }

      // iframe æ›´æ–°ï¼šç”ŸæˆHTMLã¯ /gen/ ã®ãƒ‘ã‚¹ã§å‚ç…§ã™ã‚‹
      function updateIframe() {
        const projectName = getProjectName();
        document.getElementById('htmlDisplay').src = `/gen/${projectName}.html?t=${new Date().getTime()}`;
      }


    // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¨­å®šãƒœã‚¿ãƒ³ï¼šæŠ¼ã•ã‚ŒãŸã¨ãã«ã€ã‚µãƒ¼ãƒã‹ã‚‰å±¥æ­´ã¨ãƒ¦ãƒ¼ã‚¶ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’èª­ã¿è¾¼ã¿ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåã‚’ä¿å­˜ã™ã‚‹
    document.getElementById('setProject').addEventListener('click', async () => {
      const projectName = getProjectName();
      localStorage.setItem('currentProjectName', projectName);
      await loadUserSystemPrompt();
      await loadChatHistory();
      updateIframe();
    });

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã”ã¨ã®å±¥æ­´ã¨ãƒ¦ãƒ¼ã‚¶ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’èª­ã¿è¾¼ã‚€
    window.addEventListener('load', async () => {
      await loadUserSystemPrompt();
      await loadChatHistory();
      updateIframe();
    });

    // ãƒãƒ£ãƒƒãƒˆé€ä¿¡å‡¦ç†ï¼šã‚µãƒ¼ãƒã‹ã‚‰ã®è¿”ä¿¡å¾Œã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å…¥åŠ›æ¬„ã‚’ã‚¯ãƒªã‚¢ã™ã‚‹
    document.getElementById('sendChat').addEventListener('click', async () => {
      const projectName = getProjectName();
      const userSystemPrompt = document.getElementById('systemPrompt').value;
      const payload = {
        userSystemPrompt: userSystemPrompt,
        userMessage: document.getElementById('chatInput').value,
        projectName: projectName
      };
      document.getElementById('progressIndicator').style.display = 'block';
      try {
        const response = await fetch('/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        await response.json();
        await loadChatHistory();
        updateIframe();
        // ã‚µãƒ¼ãƒã‹ã‚‰ã®è¿”ä¿¡å¾Œã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å…¥åŠ›æ¬„ã‚’ã‚¯ãƒªã‚¢ã™ã‚‹
        document.getElementById('chatInput').value = "";
        playNotificationSound();  // çµæœåˆ°ç€æ™‚ã«ã‚µã‚¦ãƒ³ãƒ‰ã‚’é³´ã‚‰ã™
      } catch (error) {
        console.error('Error sending chat:', error);
      } finally {
        document.getElementById('progressIndicator').style.display = 'none';
      }
    });

    // å±¥æ­´ã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³ï¼šã‚µãƒ¼ãƒä¸Šã®ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‚’å‰Šé™¤ã™ã‚‹
    document.getElementById('clearHistory').addEventListener('click', async () => {
      const projectName = getProjectName();
      try {
        const response = await fetch(`/chatHistory?projectName=${encodeURIComponent(projectName)}`, { method: 'DELETE' });
        if (response.ok) {
          updateChatHistoryDisplay([]);
        }
      } catch (e) {
        console.error("Error clearing chat history:", e);
      }
    });
    function playNotificationSound() {
      // AudioContext ã®ç”Ÿæˆï¼ˆãƒ–ãƒ©ã‚¦ã‚¶äº’æ›å¯¾å¿œï¼‰
      const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      
      // OscillatorNode ã®ç”Ÿæˆï¼ˆsine æ³¢ï¼‰
      const oscillator = audioCtx.createOscillator();
      oscillator.type = 'sine';
      oscillator.frequency.setValueAtTime(480, audioCtx.currentTime); // å‘¨æ³¢æ•°480Hz
      
      // GainNode ã®ç”Ÿæˆï¼ˆéŸ³é‡èª¿æ•´ç”¨ï¼‰
      const gainNode = audioCtx.createGain();
      // åˆæœŸéŸ³é‡è¨­å®šï¼ˆ0.1ç¨‹åº¦ã®ä½ã‚ã®éŸ³é‡ï¼‰
      gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
      
      // ã‚¨ãƒ³ãƒ™ãƒ­ãƒ¼ãƒ—ã®è¨­å®šï¼š0.1 ã®éŸ³é‡ã‹ã‚‰ 0.3ç§’å¾Œã« 0.001 ã¾ã§æŒ‡æ•°çš„ã«æ¸›è¡°
      gainNode.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.3);
      
      // ãƒãƒ¼ãƒ‰ã®æ¥ç¶šï¼šoscillator -> gainNode -> å‡ºåŠ›å…ˆ
      oscillator.connect(gainNode);
      gainNode.connect(audioCtx.destination);
      
      // éŸ³ã®é–‹å§‹ã¨åœæ­¢
      oscillator.start();
      oscillator.stop(audioCtx.currentTime + 0.3);
    }
    

  </script>
</body>
</html>
